name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Deploy to Webhost
        run: |
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='.github*' \
            --exclude='.phan*' \
            --exclude='.env*' \
            --exclude='vendor' \
            --exclude='docker' \
            --exclude='.dockerignore' \
            --exclude='tests' \
            --exclude='db' \
            --exclude='container' \
            --exclude='Dockerfile' \
            --exclude='docker-compose.yml' \
            --exclude='makefile' \
            --exclude='php-artisan' \
            --exclude='phpunit*' \
            --exclude='composer' \
            --exclude='vite*' \
            --exclude='package.json' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}

      - name: Post-deployment tasks
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            cd ${{ secrets.SERVER_PATH }}
            /opt/alt/php83/usr/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader
            /opt/alt/php83/usr/bin/php artisan migrate --force
            /opt/alt/php83/usr/bin/php artisan route:cache
            /opt/alt/php83/usr/bin/php artisan optimize
          EOF
